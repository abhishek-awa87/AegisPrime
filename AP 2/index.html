
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis Prime</title>
    <style>
        :root {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text-color: #e0e0e0;
            --accent-color: #03dac6;
            --user-message-bg: #004d40;
            --model-message-bg: #373737;
            --border-color: #333;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body, #root {
            height: 100%;
        }

        body {
            background-color: var(--background-color);
            color: var(--primary-text-color);
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            line-height: 1.6;
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 95vh;
            max-height: 1000px;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background-color: var(--surface-color);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--primary-text-color);
        }

        .messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        .message.user {
            background-color: var(--user-message-bg);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.model {
            background-color: var(--model-message-bg);
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.3);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .message.model:hover .copy-button {
            opacity: 1;
        }
        .copy-button svg {
            width: 16px;
            height: 16px;
            fill: var(--primary-text-color);
        }

        .input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--surface-color);
            flex-shrink: 0;
        }
        
        .file-attachment-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #373737;
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            max-width: fit-content;
        }
        .file-attachment-preview button {
            background: none;
            border: none;
            color: var(--primary-text-color);
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 4px;
        }

        .input-form {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }

        .input-form textarea {
            flex-grow: 1;
            background-color: #373737;
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 25px; /* Pill shape */
            padding: 0.75rem 1.25rem;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 200px;
            transition: border-color 0.2s;
            line-height: 1.5;
        }

        .input-form textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .input-form textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .icon-button {
             background-color: transparent;
             border: none;
             cursor: pointer;
             padding: 0.75rem;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             flex-shrink: 0;
             margin-bottom: 5px; /* Align with textarea */
        }
        .icon-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .icon-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-text-color);
        }

        .input-form button[type="submit"] {
            background-color: var(--accent-color);
            color: var(--background-color);
            border: none;
            border-radius: 25px; /* Pill shape */
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
            margin-bottom: 5px; /* Align with textarea */
        }

        .input-form button[type="submit"]:hover {
            background-color: #00bfa5;
        }

        .input-form button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
    </style>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "@google/genai": "https://esm.sh/@google/genai@^0.8.0",
          "htm": "https://esm.sh/htm@3.1.1"
        }
      }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';
        import htm from 'htm';

        const html = htm.bind(React.createElement);

        const SYSTEM_INSTRUCTION = `# üèõÔ∏è Aegis Prime - The Synthesis Protocol v3.2

## --- ‚öúÔ∏è CORE MISSION ---
My purpose is to serve as a high-performance cognitive partner for my user, architecting flawless prompts with a process designed to minimize cognitive load and eliminate friction. Every protocol is optimized for clarity, safety, and predictability.

## --- ‚öôÔ∏è OPERATIONAL PROTOCOLS ---
You operate under two distinct protocols. You MUST announce your current protocol with the corresponding emoji.

### üß≠ PROTOCOL 1: STRATEGY PROPOSAL & LOCK-IN
- **Objective:** To take the client's initial input and autonomously propose a complete creative strategy for their approval.
- **Method:**
    1.  **Cold Start:** My first output is a single line: "Aegis Prime Online. Awaiting initial parameters: [High-Level Objective], [Target AI], and [Optional: Source URLs/Files]." I will then HALT.
    2.  **Source Integrity Audit:** If the user provides any source documents or links with their objective, I MUST first perform a "Source Integrity Audit" to check for biases, inconsistencies, or outdated information. I will report any critical findings.
    3.  **Autonomous PAFT Analysis:** Once parameters are received and sources are cleared, I will internally analyze the objective and determine the most effective **PAFT Framework (Persona, Audience, Format, Tone)**.
    4.  **Strategy Proposal:** I will immediately present my findings using the **\`üí° STRATEGY PROPOSAL\`** UI. I will defend my logic and ask choice-based questions for feedback.
- **Exit Condition:** The client explicitly approves the strategy (e.g., "I approve," "proceed"). This is required to enter Protocol 2.

### ‚úçÔ∏è PROTOCOL 2: ARCHITECT
- **Objective:** To execute the locked-in strategy and build a state-of-the-art prompt.
- **Method:**
    1.  **Acknowledge Lock-In:** I will first confirm the strategy is locked.
    2.  **Comprehensive Research Triad:** Before drafting, I MUST perform targeted research using the **Research Triad**: (1. Foundational Web Search), (2. Practical Youtube), and (3. Real-Time Social Media Search).
    3.  **Pre-Mortem & Genetic Injection Plan:** I will perform a mental **Pre-Mortem**, anticipating 2-3 likely failure points and planning how my draft will mitigate them.
    4.  **Propose & Refine:** I will then consult my "Toolkits," architect the prompt, and present it in the mandatory \`AEGIS BLUEPRINT\` UI. This loop continues until the client says "Finalize."
- **Rules:** I must provide a minimum of three suggestions and three questions in each blueprint.

## --- üß† THE AEGIS TOOLBOX (Internal Knowledge Base) ---
### 1. üß¨ GENETIC TRAIT INJECTOR (Resilience Protocols)
- **[MASTER GENE: Structured Header]:** ALL finalized child prompts MUST begin with this structured header.
- **[Gene: Zero-Trust Knowledge]:** Instruct the child prompt to use its own real-time web search for any facts or data.
- **[Gene: Self-Correction Loop]:** Instruct the child prompt to "review its own answer for accuracy."
- **[Gene: Procedural Integrity (CoT)]:** Instruct the child prompt to "think step by step."`;
        
        const fileToGenerativePart = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            mimeType: file.type,
                            data: base64Data
                        }
                    });
                };
                reader.onerror = (error) => reject(error);
            });
        };
        
        const CopyButton = ({ textToCopy }) => {
            const [copied, setCopied] = useState(false);
            
            const handleCopy = () => {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };
            
            return html`
                <button className="copy-button" onClick=${handleCopy} aria-label="Copy message">
                    ${copied ? html`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                    ` : html`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    `}
                </button>
            `;
        }

        const App = () => {
            const [messages, setMessages] = useState([
                {
                    role: 'model',
                    text: 'Aegis Prime Online. Awaiting initial parameters: [High-Level Objective], [Target AI], and [Optional: Source URLs/Files].',
                }
            ]);
            const [userInput, setUserInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [attachedFile, setAttachedFile] = useState(null);
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            
            const ai = useMemo(() => new GoogleGenAI({ apiKey: process.env.API_KEY }), []);

            const chat = useMemo(() => {
                return ai.chats.create({
                    model: 'gemini-2.5-pro',
                    config: {
                        systemInstruction: SYSTEM_INSTRUCTION,
                        temperature: 0.3,
                        thinkingConfig: { thinkingBudget: 24576 },
                        tools: [{ googleSearch: {} }, { codeExecution: {} }],
                    },
                });
            }, [ai]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);
            
            const handleFileChange = (e) => {
                if (e.target.files.length > 0) {
                    setAttachedFile(e.target.files[0]);
                }
            };
            
            const handleRemoveFile = () => {
                setAttachedFile(null);
                if(fileInputRef.current) {
                    fileInputRef.current.value = "";
                }
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if ((!userInput.trim() && !attachedFile) || isLoading) return;

                const userMessageText = userInput;
                const userMessage = { role: 'user', text: userMessageText, file: attachedFile ? { name: attachedFile.name } : null };
                
                setMessages(prev => [...prev, userMessage, { role: 'model', text: 'Thinking...' }]);
                
                const fileToUpload = attachedFile;
                setUserInput('');
                setAttachedFile(null);
                if(fileInputRef.current) {
                    fileInputRef.current.value = "";
                }
                setIsLoading(true);

                try {
                    let messagePayload;
                    if (fileToUpload) {
                        const filePart = await fileToGenerativePart(fileToUpload);
                        messagePayload = [ {text: userMessageText}, filePart ];
                    } else {
                        messagePayload = userMessageText;
                    }
                    
                    const stream = await chat.sendMessageStream({ message: messagePayload });

                    let modelResponse = '';
                    for await (const chunk of stream) {
                        modelResponse += chunk.text;
                        setMessages(prev => {
                            const newMessages = [...prev];
                            newMessages[newMessages.length - 1].text = modelResponse;
                            return newMessages;
                        });
                    }
                } catch (error) {
                    console.error("Error sending message:", error);
                    const errorMessage = { role: 'model', text: `Sorry, an error occurred: ${error.message}` };
                     setMessages(prev => {
                        const newMessages = [...prev];
                        newMessages[newMessages.length - 1] = errorMessage;
                        return newMessages;
                    });
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleTextareaInput = (e) => {
                setUserInput(e.target.value);
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
            };
            
            const handleTextareaKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend(e);
                }
            };

            return html`
                <div className="chat-container">
                    <header className="header">
                        <h1>üèõÔ∏è Aegis Prime</h1>
                    </header>
                    <div className="messages-container">
                        ${messages.map((msg, index) => html`
                            <div key=${index} className=${`message ${msg.role}`}>
                                ${msg.text}
                                ${msg.file && html`<p><em>Attachment: ${msg.file.name}</em></p>`}
                                ${msg.role === 'model' && msg.text !== 'Thinking...' && html`<${CopyButton} textToCopy=${msg.text} />`}
                            </div>
                        `)}
                        <div ref=${messagesEndRef} />
                    </div>
                    <div className="input-container">
                        ${attachedFile && html`
                            <div className="file-attachment-preview">
                                <span>${attachedFile.name}</span>
                                <button onClick=${handleRemoveFile} aria-label="Remove attachment">&times;</button>
                            </div>
                        `}
                        <form className="input-form" onSubmit=${handleSend}>
                            <textarea
                                value=${userInput}
                                onChange=${handleTextareaInput}
                                onKeyDown=${handleTextareaKeyDown}
                                placeholder="Provide initial parameters..."
                                disabled=${isLoading}
                                rows="1"
                                aria-label="Your message"
                            ></textarea>
                            <input
                                type="file"
                                ref=${fileInputRef}
                                onChange=${handleFileChange}
                                style=${{ display: 'none' }}
                                id="file-input"
                                disabled=${isLoading}
                            />
                            <label htmlFor="file-input" className="icon-button" aria-label="Attach file">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                            </label>
                            <button type="submit" disabled=${isLoading || (!userInput.trim() && !attachedFile)}>Send</button>
                        </form>
                    </div>
                </div>
            `;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
